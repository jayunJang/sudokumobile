<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>Sudoku – Lone Digits (Mobile)</title>
  <style>
    :root{ --red:#E7364E; --white:#FFFFFF; --grid-gap:1px; }
    @import url('https://fonts.googleapis.com/css2?family=Lexend+Deca:wght@100..900&family=Roboto+Flex:opsz,wght@8..144,100..1000&display=swap');

    html,body{height:100%;}
    body{
      margin:0; background:var(--red); color:var(--white);
      font-family: "Lexend Deca", system-ui, -apple-system, Segoe UI, Roboto, 'Noto Sans KR', Arial, sans-serif;
      -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale;
      display:flex; flex-direction:column; align-items:center;
    }
    .app{width: min(393px, 100vw); min-height: 100vh; box-sizing: border-box; padding: 24px 20px 28px;}
    .logo{display:block; margin:0 auto; width:140px; height:40px; object-fit:contain; object-position:center;}
    .timer{display:flex; align-items:center; gap:8px; margin:12px 0 16px; font-weight:600; letter-spacing:0.2px;}
    .timer img{width:16px; height:16px; display:block;}
    .board-wrap{display:flex; justify-content:center;}
    .board{ width: min(320px, 90vw); aspect-ratio:1 / 1; position:relative; box-sizing:border-box;}
    .board::before{content:""; position:absolute; inset:0; border:2px solid var(--white); pointer-events:none;}
    .grid{position:absolute; inset:0; display:grid; grid-template-columns:repeat(9,1fr); grid-template-rows:repeat(9,1fr);}
    .cell{ position:relative; display:flex; align-items:center; justify-content:center; font-weight:600; font-size:18px; box-shadow: inset 0 0 0 1px rgba(255,255,255,0.6); }
    .cell.block-r::after, .cell.block-c::before{ content:""; position:absolute; background:var(--white); }
    .cell.block-r::after{ height:2px; left:0; right:0; bottom:-1px; }
    .cell.block-c::before{ width:2px; top:0; bottom:0; right:-1px; }
    .given{ color: var(--white); opacity: 1; }
    .val{ color: var(--white); }
    .cell:hover .overlay, .cell.selected .overlay{ opacity: 0.22; }
    .overlay{ position:absolute; inset:0; background: var(--white); opacity:0; transition:opacity .12s ease; pointer-events:none; }
    .overlay.wrong{ opacity:0.8 !important; }
    .pad{ display:grid; grid-template-columns: repeat(5, 1fr); gap:12px; width: min(360px, 94vw); margin:24px auto 20px; }
    .key{ height:48px; border:2px solid var(--white); color:var(--white); background:transparent; border-radius:6px; font-size:18px; font-weight:600; letter-spacing:0.4px;}
    .key:active, .key.pressed{ background:var(--white); color:var(--red); }
    .key[disabled]{ opacity:.4; }
    .submit{ display:block; margin:12px auto 0; width: 180px; height:40px; border-radius:12px; background:var(--white); color:var(--red); border:none; font-weight:700; letter-spacing:1px; }
    .submit:disabled{ opacity:.65; }
    .spacer{ height: 18px; }
  </style>
</head>
<body>
  <div class="app">
    <img class="logo" src="logo.png" alt="Sudoku Festival Logo" />
    <div class="timer" id="timerWrap">
      <img src="timer.png" alt="timer" />
      <div id="timer">00:00</div>
    </div>
    <div class="board-wrap">
      <div class="board" id="board">
        <div class="grid" id="grid"></div>
      </div>
    </div>
    <div class="spacer"></div>
    <div class="pad" id="pad">
      <button class="key" data-n="1">1</button>
      <button class="key" data-n="2">2</button>
      <button class="key" data-n="3">3</button>
      <button class="key" data-n="4">4</button>
      <button class="key" data-n="5">5</button>
      <button class="key" data-n="6">6</button>
      <button class="key" data-n="7">7</button>
      <button class="key" data-n="8">8</button>
      <button class="key" data-n="9">9</button>
      <button class="key" id="erase" aria-label="erase"><img src="backspace.png"/></button>
    </div>
    <button class="submit" id="submit" disabled>SUBMIT</button>
  </div>

<script>
  /* ===== 퍼즐 데이터 ===== */
  const puzzle = [
    [0,5,0,6,0,0,0,4,0], 
    [0,0,9,2,5,0,0,0,7], 
    [4,8,0,0,0,0,0,3,0], 
    [3,0,1,0,0,2,0,0,8], 
    [0,4,0,5,0,0,6,2,0], 
    [0,0,2,3,0,0,1,0,0], 
    [8,2,0,0,4,0,5,0,0], 
    [0,0,0,0,3,7,0,0,0], 
    [7,0,0,0,0,0,0,8,6]
  ];
  const solution = [
    [2,5,7,6,8,3,9,4,1],
    [1,3,9,2,5,4,8,6,7],
    [4,8,6,7,1,9,2,3,5],
    [3,6,1,4,9,2,7,5,8],
    [9,4,8,5,7,1,6,2,3],
    [5,7,2,3,6,8,1,9,4],
    [8,2,3,1,4,6,5,7,9],
    [6,9,5,8,3,7,4,1,2],
    [7,1,4,9,2,5,3,8,6]
  ];
  const given = puzzle.map(row=>row.map(v=>v!==0));
  let grid = puzzle.map(r=>r.slice());
  let selected = {r:null,c:null};
  let wrong = Array.from({length:9}, ()=>Array(9).fill(false));

  /* ===== UI 빌드 ===== */
  const gridEl = document.getElementById('grid');
  function buildGrid(){
    gridEl.innerHTML = '';
    for(let r=0;r<9;r++){
      for(let c=0;c<9;c++){
        const cell = document.createElement('div');
        cell.className = 'cell';
        if((r%3===2) && r!==8) cell.classList.add('block-r');
        if((c%3===2) && c!==8) cell.classList.add('block-c');
        const overlay = document.createElement('div');
        overlay.className = 'overlay';
        if(wrong[r][c]) overlay.classList.add('wrong');
        cell.appendChild(overlay);
        const v = grid[r][c];
        if(v){
          const span = document.createElement('span');
          span.textContent = v;
          span.className = given[r][c] ? 'given' : 'val';
          cell.appendChild(span);
        }
        cell.addEventListener('click', ()=> selectCell(r,c,cell));
        gridEl.appendChild(cell);
      }
    }
  }
  function redrawCell(r,c){
    const idx = r*9 + c;
    const cell = gridEl.children[idx];
    cell.classList.remove('selected');
    cell.innerHTML = '<div class="overlay"></div>';
    const overlay = cell.querySelector('.overlay');
    if(wrong[r][c]) overlay.classList.add('wrong');
    const v = grid[r][c];
    if(v){
      const span = document.createElement('span');
      span.textContent = v;
      span.className = given[r][c] ? 'given' : 'val';
      cell.appendChild(span);
    }
    if(selected.r===r && selected.c===c){ cell.classList.add('selected'); }
  }
  function selectCell(r,c,el){
    if(given[r][c]){ selected={r:null,c:null};
      document.querySelectorAll('.cell').forEach(e=>e.classList.remove('selected')); return; }
    selected = {r,c};
    document.querySelectorAll('.cell').forEach(e=>e.classList.remove('selected'));
    el.classList.add('selected');
  }
  document.querySelectorAll('.key[data-n]').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const n = +btn.dataset.n;
      pressFx(btn);
      if(selected.r==null) return;
      wrong = wrong.map(row=>row.map(()=>false));
      grid[selected.r][selected.c] = n;
      redrawCell(selected.r, selected.c);
      checkSubmitState();
      window.navigator.vibrate?.(10);
    }, {passive:true});
  });
  document.getElementById('erase').addEventListener('click', (e)=>{
    pressFx(e.currentTarget);
    if(selected.r==null) return;
    wrong = wrong.map(row=>row.map(()=>false));
    grid[selected.r][selected.c] = 0;
    redrawCell(selected.r, selected.c);
    checkSubmitState();
  }, {passive:true});
  function pressFx(btn){ btn.classList.add('pressed'); setTimeout(()=>btn.classList.remove('pressed'), 140); }
  function checkSubmitState(){
    const filled = grid.every(row=>row.every(v=>v!==0));
    document.getElementById('submit').disabled = !filled;
  }

  /* ===== 타이머 ===== */
  const timerEl = document.getElementById('timer');
  const t0 = Date.now();
  function getElapsedSeconds(){ return Math.floor((Date.now()-t0)/1000); }
  const tHandle = setInterval(()=>{
    const s = getElapsedSeconds();
    const m = String(Math.floor(s/60)).padStart(2,'0');
    const ss = String(s%60).padStart(2,'0');
    timerEl.textContent = `${m}:${ss}`;
  }, 1000);

/* 화면에 보이는 타이머 텍스트를 초로 변환 */
function getDisplayedSeconds(){
  const [m, s] = document.getElementById('timer').textContent.split(':').map(Number);
  return (m|0)*60 + (s|0);
}

  /* ===== 정답 검증 ===== */
  function validate(){
    wrong = wrong.map(row=>row.map(()=>false));
    let ok = true;
    for(let r=0;r<9;r++){
      for(let c=0;c<9;c++){
        if(grid[r][c]!==solution[r][c]){ ok=false; wrong[r][c]=true; }
      }
    }
    for(let r=0;r<9;r++) for(let c=0;c<9;c++) redrawCell(r,c);
    return ok;
  }

  /* ====== 시트 저장 ====== */
  // ⛳ 여기에 "Add new Rows as JSON objects" 엔드포인트 + ?tabId=records 를 넣으세요.
  const ADD_URL = "https://script.google.com/macros/s/AKfycbyW80ocyuXeZKgauKt6oOgMvacUHbxQxDLBRHWIXKTJr1ySScNTv20-NWxSaWp-LzHD/exec";

 async function submitRecord(name, seconds){
  const body = [{
    timestamp: new Date().toISOString(),
    name: String(name).slice(0,20),
    seconds: Number(seconds),
    source: "mobile"
  }];

  // CORS 회피: no-cors (응답은 읽지 못하지만, 서버는 정상 처리)
  await fetch(ADD_URL, {
    method: "POST",
    mode: "no-cors",
    // 헤더 넣지 마세요. (헤더 넣으면 프리플라이트 발생)
    body: JSON.stringify(body)
  });

  // 서버 응답을 못 읽으므로 여기선 단순 성공으로 간주
  return true;
}

  /* ===== SUBMIT 버튼 ===== */
  document.getElementById('submit').addEventListener('click', async ()=>{
    clearInterval(tHandle);
    if(!validate()){
      alert('틀린 부분이 있습니다.');
      return;
    }
    alert('축하합니다! 모두 맞혔습니다.');
    const nick = prompt('닉네임을 입력하세요');
    if(!nick) return;

    // 버튼 중복방지
    const btn = document.getElementById('submit');
    btn.disabled = true;

    const elapsedSec = getDisplayedSeconds(); // ← 화면에 보이는 그 시간 그대로 저장

    try{
      await submitRecord(nick, elapsedSec);
      alert(`${nick}님의 기록이 서버에 저장되었습니다!`);
    }catch(e){
      console.error(e);
      alert('서버 저장 실패: ' + e.message);
      btn.disabled = false; // 실패 시 다시 가능
      return;
    }

    // (선택) 로컬에도 계속 저장
    const prev = JSON.parse(localStorage.getItem('sudokuRecords')||'[]');
    prev.push({ name:nick, seconds: elapsedSec });
    localStorage.setItem('sudokuRecords', JSON.stringify(prev));
  });

  /* ===== 시작 ===== */
  buildGrid();
</script>
</body>
</html>
